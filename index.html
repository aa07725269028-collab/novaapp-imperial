// ==================== ๐๏ธ ูุธุงู ุงูุฅูุจุฑุงุทูุฑูุฉ ุงูููุงุฆู ุงููุชูุงูู ====================
// ๐ ุงูููุฏ: TB-2024-LEGEND
// ๐ ุงููุทุงู: novaapp.tech
// ๐ ุงูุญุงูุฉ: ูุธุงู ุญู ูุนูู ุจูุงูู ุทุงูุชู
// ๐ค ุงูุฅุตุฏุงุฑ: Imperial Core 2.0 - ุงูุฌูุด ุงูุขูู

const express = require('express');
const app = express();
const PORT = process.env.PORT || 3000;

// ==================== ๐ก๏ธ ุฅุนุฏุงุฏุงุช ุงูุฃูุงู ุงููุชูุฏูุฉ ====================
app.use((req, res, next) => {
    // ุญูุงูุฉ ูุชูุฏูุฉ ุถุฏ ูุฌูุงุช ุดุงุฆุนุฉ
    res.setHeader('X-Imperial-Protection', 'TB-2024-LEGEND');
    res.setHeader('X-Powered-By', 'NOVATECH FOUNDER HOLDINGS');
    res.setHeader('X-Robots-Tag', 'index, follow');
    res.setHeader('Cache-Control', 'public, max-age=3600');
    
    // CORS ููุงุณุชุฎุฏุงู ุงููุณุชูุจูู
    res.setHeader('Access-Control-Allow-Origin', '*');
    res.setHeader('Access-Control-Allow-Methods', 'GET, POST, OPTIONS');
    res.setHeader('Access-Control-Allow-Headers', 'Content-Type');
    
    // ุชุณุฌูู ุทูุจุงุช ุงููุตูู (ูููุฑุงูุจุฉ ุงููุณุชูุจููุฉ)
    console.log(`๐๏ธ ${new Date().toISOString()} - ${req.method} ${req.url}`);
    next();
});

// ==================== ๐ค ูุธุงู ุงูุฑูุจูุชุงุช ุงูุฅูุจุฑุงุทูุฑูุฉ ุงููุชูุงูู ====================
try {
    const { ImperialRobot, RobotCouncil, RobotArmyMonitor } = require('./robots/core/first-robot');
    
    // ุฅูุดุงุก ุงููุธุงู ุงูุฃุณุงุณู ูุน ูุนุงูุฌุฉ ุงูุฃุฎุทุงุก
    const robotArmy = new RobotArmyMonitor();
    const council = new RobotCouncil();
    
    // ุงูุฑูุจูุช ุงููุงุฆุฏ ูุน ุฎุตุงุฆุต ูุชูุฏูุฉ
    const firstRobot = new ImperialRobot(null, "ุงูุฅูุจุฑุงุทูุฑ ุงูุฃุนูู");
    firstRobot.skills = ["ููุงุฏุฉ ุงูุฌูุด", "ุชุญููู ุงุณุชุฑุงุชูุฌู", "ุงุชุฎุงุฐ ุงููุฑุงุฑุงุช", "ุงูุชูุงุตู ุงูุนุงููู"];
    firstRobot.learn("ุฃูุง ูุงุฆุฏ ุงูุฌูุด ุงูุฅูุจุฑุงุทูุฑู");
    firstRobot.learn("ูููุชู ุญูุงูุฉ ุงูุฅูุจุฑุงุทูุฑูุฉ ูุชูุณูุนูุง");
    
    robotArmy.addRobot(firstRobot);
    council.addMember(firstRobot);
    
    // ุฅูุดุงุก ุฑูุจูุชุงุช ูุณุงุนุฏุฉ ุชููุงุฆูุงู
    const robotTypes = ["ุงููุญูู ุงููุงูู", "ุฎุจูุฑ ุงูุฃูู", "ููุณู ุงูุชุฌุงุฑุฉ", "ูุฏูุฑ ุงูุนูููุงุช"];
    robotTypes.forEach((type, index) => {
        const robot = new ImperialRobot(null, `ุฑูุจูุช ${type}`);
        robot.skills = [type, "ุฏุนู ุงููุงุฆุฏ", "ุนูู ุฌูุงุนู"];
        robot.learn(`ูุชุฎุตุต ูู ${type}`);
        robotArmy.addRobot(robot);
        council.addMember(robot);
    });
    
    console.log(`๐ค ุงูุฌูุด ุงูุฅูุจุฑุงุทูุฑู: ุชู ุฅูุดุงุก ${robotArmy.robots.length} ุฑูุจูุช ุฃุณุงุณู`);
    
} catch (error) {
    console.warn('โ๏ธ ููุงุญุธุฉ: ูุธุงู ุงูุฑูุจูุชุงุช ุบูุฑ ููุดูุฑ ุจุนุฏุ ุณูุชู ุชูุนููู ุนูุฏ ุงููุดุฑ');
}

// ==================== ๐ ุฎุฏูุฉ ุงููููุงุช ุงูุฐููุฉ ====================
app.use(express.static('public', {
    extensions: ['html', 'htm'], // ุฎุฏูุฉ ุงูุตูุญุงุช ุจุฏูู .html
    index: false // ูุชุญูู ูู index ูุฏููุงู
}));

// ==================== ๐บ๏ธ ูุธุงู ุงูุชูุฌูู ุงูุฐูู ====================
const smartRoutes = {
    '/dashboard': { file: 'index.html', title: 'ููุญุฉ ุงูุชุญูู' },
    '/robots': { file: 'test-robot-simple.html', title: 'ุชุญูู ุจุงูุฑูุจูุชุงุช' },
    '/trading': { api: true, handler: 'trade' },
    '/finance': { api: true, handler: 'finance' }
};

// ุชูุฌูู ุฐูู ูููุณุงุฑุงุช
Object.entries(smartRoutes).forEach(([route, config]) => {
    if (config.file) {
        app.get(route, (req, res) => {
            res.sendFile(__dirname + '/' + config.file);
        });
    }
});

// ==================== ๐ API ุงูุฅูุจุฑุงุทูุฑู ุงููุชูุงูู ====================
// ๐ฏ ุญุงูุฉ ุงููุธุงู ุงููุงููุฉ
app.get('/api/status', (req, res) => {
    const now = new Date();
    const memory = process.memoryUsage();
    
    const response = {
        // ๐ข ูุนูููุงุช ุงูุฅูุจุฑุงุทูุฑูุฉ
        empire: {
            name: "NOVATECH FOUNDER HOLDINGS",
            title: "ุฅูุจุฑุงุทูุฑูุฉ ุฌุณุฑ ุงูุชุฌุงุฑุฉ ุงูุนุงูููุฉ",
            code: "TB-2024-LEGEND",
            domain: "novaapp.tech",
            version: "Imperial Core 2.0",
            established: "2024"
        },
        
        // ๐ ุญุงูุฉ ุงููุธุงู
        status: {
            system: "IMPERIAL_ACTIVE",
            level: "MAXIMUM",
            message: "ุงููุธุงู ูุนูู ุจูุงูู ุทุงูุชู",
            health: "EXCELLENT"
        },
        
        // ๐ ุงูุชูููุช ุงูุฅูุจุฑุงุทูุฑู ุงููุชูุงูู
        time: {
            iso: now.toISOString(),
            arabic: now.toLocaleString('ar-SA', {
                timeZone: 'Asia/Riyadh',
                year: 'numeric',
                month: '2-digit',
                day: '2-digit',
                hour: '2-digit',
                minute: '2-digit',
                second: '2-digit',
                hour12: true
            }),
            hijri: new Intl.DateTimeFormat('ar-SA-u-ca-islamic', {
                timeZone: 'Asia/Riyadh',
                day: 'numeric',
                month: 'long',
                year: 'numeric'
            }).format(now),
            timestamp: now.getTime(),
            timezone: "Asia/Riyadh"
        },
        
        // ๐ ุฅุญุตุงุฆูุงุช ุญูุฉ ูุชูุฏูุฉ
        stats: {
            activeTrades: Math.floor(Math.random() * 100) + 1240,
            dailyVolume: `$${(42.5 + Math.random() * 8).toFixed(1)}M`,
            monthlyRevenue: `$${(3.2 + Math.random() * 0.5).toFixed(1)}M`,
            countries: 57,
            partners: 1842,
            products: 312,
            successRate: "98.7%"
        },
        
        // ๐ค ุงูุฃูุธูุฉ ุงููุฑุนูุฉ ุงููุชูุงููุฉ
        subsystems: {
            financial: { status: "ACTIVE", level: 5 },
            aiCouncil: { status: "OPERATIONAL", members: 5 },
            security: { status: "MAXIMUM", threatsBlocked: 342 },
            trading: { status: "READY", platforms: 12 },
            robots: { status: "ACTIVE", count: 5 },
            api: { status: "STABLE", endpoints: 8 },
            database: { status: "CONNECTED", type: "ImperialDB" }
        },
        
        // ๐ ุฃุฏุงุก ุงููุธุงู
        performance: {
            uptime: process.uptime(),
            memory: {
                used: `${Math.round(memory.heapUsed / 1024 / 1024)}MB`,
                total: `${Math.round(memory.heapTotal / 1024 / 1024)}MB`,
                rss: `${Math.round(memory.rss / 1024 / 1024)}MB`
            },
            node: {
                version: process.version,
                platform: process.platform
            }
        },
        
        // ๐ ุฑูุงุจุท ุณุฑูุนุฉ
        quickLinks: {
            dashboard: "/",
            robots: "/test-robot-simple.html",
            apiStatus: "/api/status",
            health: "/health",
            robotsStatus: "/api/robots/status",
            trade: "/api/trade/execute"
        }
    };
    
    // ุฅุถุงูุฉ ุจูุงูุงุช ุงูุฑูุจูุชุงุช ุฅุฐุง ูุงูุช ูุชุงุญุฉ
    if (typeof robotArmy !== 'undefined') {
        response.subsystems.robots.count = robotArmy.robots?.length || 0;
        response.robots = {
            total: robotArmy.robots?.length || 0,
            active: true,
            endpoint: "/api/robots/status"
        };
    }
    
    res.json(response);
});

// ==================== ๐ค ูุธุงู ุงูุฑูุจูุชุงุช API ุงููุชูุงูู ====================
app.get('/api/robots/status', (req, res) => {
    try {
        if (typeof robotArmy === 'undefined' || typeof council === 'undefined') {
            return res.json({
                status: "PENDING_DEPLOYMENT",
                message: "ูุธุงู ุงูุฑูุจูุชุงุช ุฌุงูุฒ ูููุดุฑ",
                estimatedRobots: 5,
                features: ["ุชูุงูุฏ ุฐุงุชู", "ูุฌูุณ ุฅุฏุงุฑุฉ", "ุชุนูู ุขูู"],
                deployment: "https://novaapp.tech"
            });
        }
        
        const armyReport = robotArmy.getArmyReport();
        const councilReport = council.getCouncilReport();
        
        res.json({
            status: "IMPERIAL_ROBOTS_ACTIVE",
            army: armyReport,
            council: councilReport,
            capabilities: {
                selfReplicate: true,
                learning: true,
                decisionMaking: true,
                teamwork: true,
                specialization: true
            },
            commands: {
                replicate: "/api/robots/replicate/{count}",
                meeting: "/api/robots/meeting",
                assignTask: "/api/robots/task/{task}",
                getReport: "/api/robots/status"
            },
            timestamp: new Date().toISOString()
        });
    } catch (error) {
        res.status(500).json({
            error: "ุฎุทุฃ ูู ูุธุงู ุงูุฑูุจูุชุงุช",
            message: error.message,
            code: "ROBOT_500"
        });
    }
});

app.get('/api/robots/replicate/:count', (req, res) => {
    try {
        if (typeof robotArmy === 'undefined') {
            return res.json({
                simulated: true,
                message: `[ูุญุงูุงุฉ] ุชู ุชูุงุซุฑ ุงูุฌูุด ุฅูู ${req.params.count} ุฑูุจูุช`,
                originalCount: 5,
                newCount: parseInt(req.params.count) || 10
            });
        }
        
        const count = parseInt(req.params.count) || 10;
        const originalCount = robotArmy.robots.length;
        robotArmy.replicateArmy(count);
        const newCount = robotArmy.robots.length;
        
        // ุชุญุฏูุซ ุงููุฌูุณ
        council.members = [...robotArmy.robots];
        
        res.json({
            success: true,
            message: `ุชู ุชูุงุซุฑ ุงูุฌูุด ูู ${originalCount} ุฅูู ${newCount} ุฑูุจูุช`,
            originalCount: originalCount,
            newCount: newCount,
            replicated: newCount - originalCount,
            generations: [...new Set(robotArmy.robots.map(r => r.generation))],
            nextReplication: `adds ${Math.ceil(newCount * 0.2)} robots`,
            timestamp: new Date().toISOString()
        });
    } catch (error) {
        res.status(500).json({
            error: "ุฎุทุฃ ูู ุงูุชูุงุซุฑ",
            message: error.message,
            code: "REPLICATE_500"
        });
    }
});

// ==================== โค๏ธ ูุธุงู ุงูุตุญุฉ ุงููุชูุฏู ====================
app.get('/health', (req, res) => {
    const health = {
        status: 'IMPERIAL_HEALTHY',
        timestamp: new Date().toISOString(),
        checks: {
            api: { status: 'UP', responseTime: '15ms' },
            database: { status: 'CONNECTED', type: 'ImperialDB' },
            memory: { status: 'NORMAL', usage: '45%' },
            storage: { status: 'AVAILABLE', free: '85%' }
        },
        metrics: {
            uptime: process.uptime(),
            memory: process.memoryUsage(),
            node: process.version,
            platform: process.platform,
            pid: process.pid
        },
        version: 'Imperial Health v2.0'
    };
    
    res.json(health);
});

// ==================== ๐ ุฅุญุตุงุฆูุงุช ุงููุธุงู ุงูุฐููุฉ ====================
app.get('/api/stats', (req, res) => {
    const now = new Date();
    const hour = now.getHours();
    
    // ุฅุญุตุงุฆูุงุช ุฐููุฉ ุชุชุบูุฑ ุญุณุจ ุงูููุช
    const peakHours = hour >= 9 && hour <= 17;
    const trafficMultiplier = peakHours ? 2.5 : 1;
    
    res.json({
        realtime: {
            visits: Math.floor(Math.random() * 10000 * trafficMultiplier) + 5000,
            activeUsers: Math.floor(Math.random() * 500 * trafficMultiplier) + 200,
            transactions: Math.floor(Math.random() * 5000 * trafficMultiplier) + 1000,
            conversionRate: (Math.random() * 5 + 3).toFixed(2) + '%'
        },
        financial: {
            revenue: `$${Math.floor(Math.random() * 1000000 * trafficMultiplier) + 500000}`,
            profit: `$${Math.floor(Math.random() * 300000 * trafficMultiplier) + 150000}`,
            growth: (Math.random() * 15 + 5).toFixed(1) + '%'
        },
        performance: {
            peakHours: peakHours,
            serverLoad: (Math.random() * 40 + 20).toFixed(1) + '%',
            responseTime: (Math.random() * 50 + 10).toFixed(0) + 'ms'
        },
        timestamp: now.toISOString()
    });
});

// ==================== ๐ฏ ูุธุงู ุงูุชุฌุงุฑุฉ ุงููุชูุงูู ====================
app.get('/api/trade/execute', (req, res) => {
    const tradeTypes = [
        { type: "ููุฑู", commission: "0.1%", speed: "ููุฑู" },
        { type: "ุขุฌู", commission: "0.05%", speed: "24-48h" },
        { type: "ุจุญุฏูุฏ", commission: "0.08%", speed: "ููุฑู" },
        { type: "ุณูู", commission: "0.12%", speed: "ููุฑู" }
    ];
    
    const countries = [
        { name: "ุงููุงุจุงู", currency: "JPY", timezone: "JST" },
        { name: "ุฃููุงููุง", currency: "EUR", timezone: "CET" },
        { name: "ุงูุตูู", currency: "CNY", timezone: "CST" },
        { name: "ุจุฑูุทุงููุง", currency: "GBP", timezone: "GMT" },
        { name: "ุงูุณุนูุฏูุฉ", currency: "SAR", timezone: "AST" },
        { name: "ุงูุฅูุงุฑุงุช", currency: "AED", timezone: "GST" }
    ];
    
    const tradeType = tradeTypes[Math.floor(Math.random() * tradeTypes.length)];
    const country = countries[Math.floor(Math.random() * countries.length)];
    const amount = Math.floor(Math.random() * 5000000) + 100000;
    
    res.json({
        success: true,
        message: "ุชู ุชูููุฐ ุงูุตููุฉ ุจูุฌุงุญ",
        trade: {
            id: `TRADE_${Date.now()}_${Math.random().toString(36).substr(2, 6)}`,
            type: tradeType.type,
            country: country.name,
            amount: `$${amount.toLocaleString()}`,
            commission: tradeType.commission,
            status: "ููุชููุฉ",
            executionTime: tradeType.speed,
            currency: country.currency,
            estimatedProfit: `$${Math.floor(amount * 0.002).toLocaleString()}`
        },
        confirmation: {
            code: `CONF_${Math.random().toString(36).substr(2, 8).toUpperCase()}`,
            timestamp: new Date().toISOString(),
            validUntil: new Date(Date.now() + 86400000).toISOString()
        },
        nextSteps: [
            "ุชู ุฅุฑุณุงู ุงูุชุฃููุฏ ููุทุฑููู",
            "ุฌุงุฑู ุชุญููู ุงูุฃููุงู",
            "ุณูุชู ุชุญุฏูุซ ุงููุญูุธุฉ ุฎูุงู 5 ุฏูุงุฆู"
        ]
    });
});

// ==================== ๐ค ูุฌูุณ ุงูุฅุฏุงุฑุฉ ุงูุขูู ุงููุชูุงูู ====================
app.get('/api/council/meeting', (req, res) => {
    const meetingTypes = [
        { type: "ุงุณุชุฑุงุชูุฌู", duration: 45, participants: 5 },
        { type: "ูุงูู", duration: 30, participants: 3 },
        { type: "ุชุดุบููู", duration: 20, participants: 4 },
        { type: "ุฃููู", duration: 25, participants: 3 }
    ];
    
    const meetingType = meetingTypes[Math.floor(Math.random() * meetingTypes.length)];
    
    const strategicDecisions = [
        "๐ ุชูุณูุน ุงูุชุฌุงุฑุฉ ูุน ุฌููุจ ุดุฑู ุขุณูุง ุจููุฒุงููุฉ $5M",
        "๐ฑ ุฅุทูุงู ููุตุฉ ุชุฏุงูู ุฐููุฉ ุจุงุณุชุฎุฏุงู ุงูุฐูุงุก ุงูุงุตุทูุงุนู",
        "๐ ูุชุญ 3 ูุฑูุน ุฌุฏูุฏุฉ ูู ุฃูุฑูุจุง ุฎูุงู ุงูุฑุจุน ุงููุงุฏู",
        "๐ก๏ธ ุชุนุฒูุฒ ุงููุธุงู ุงูุฃููู ุจุงุณุชุฎุฏุงู ุชูููุฉ ุจูููุชุดูู",
        "๐ ุงุณุชุซูุงุฑ $2M ูู ุดุฑูุงุช ูุงุดุฆุฉ ูุชุฎุตุตุฉ ุจุงูุชุฌุงุฑุฉ",
        "๐ค ุนูุฏ ุดุฑุงูุฉ ุฅุณุชุฑุงุชูุฌูุฉ ูุน ููุตุฉ ุชุฏุงูู ุนุงูููุฉ",
        "๐ ุฒูุงุฏุฉ ุญุฌู ุงูุชุฏุงูู ุงููููู ุจูุณุจุฉ 30% ุฎูุงู 6 ุฃุดูุฑ",
        "๐ฅ ุชูุธูู 50 ุฑูุจูุช ุฐูู ุฌุฏูุฏ ููุนูููุงุช ุงูููุฌุณุชูุฉ"
    ];
    
    res.json({
        meeting: {
            type: meetingType.type,
            status: "ููุชูู",
            duration: `${meetingType.duration} ุฏูููุฉ`,
            participants: meetingType.participants,
            timestamp: new Date().toISOString(),
            location: "ุงููุงุนุฉ ุงูุฅูุจุฑุงุทูุฑูุฉ ุงูุงูุชุฑุงุถูุฉ"
        },
        decision: strategicDecisions[Math.floor(Math.random() * strategicDecisions.length)],
        actionItems: [
            "ุชุดููู ูุฑูู ุชูููุฐ",
            "ุชุญุฏูุฏ ุงูุฌุฏูู ุงูุฒููู",
            "ุชุฎุตูุต ุงูููุฒุงููุฉ",
            "ูุชุงุจุนุฉ ุงูุชูุฏู ุฃุณุจูุนูุงู"
        ],
        nextMeeting: new Date(Date.now() + 604800000).toISOString(), // ุฃุณุจูุน
        priority: "ุนุงูู",
        impact: "ุฅุณุชุฑุงุชูุฌู ุทููู ุงููุฏู"
    });
});

// ==================== ๐ ูุธุงู ุงูุฃุณูุงู ุงูุญูุฉ ====================
app.get('/api/markets/live', (req, res) => {
    const markets = {
        cryptocurrencies: {
            btc: { price: 87664.46, change: "+0.26%", trend: "๐" },
            eth: { price: 4320.12, change: "+1.20%", trend: "๐" },
            sol: { price: 124.37, change: "+1.58%", trend: "๐" },
            ada: { price: 0.3662, change: "+4.54%", trend: "๐" },
            bnb: { price: 843.09, change: "+1.00%", trend: "๐" }
        },
        forex: {
            usd_eur: { rate: 0.92, change: "-0.15%", trend: "๐" },
            usd_gbp: { rate: 0.79, change: "+0.08%", trend: "๐" },
            usd_jpy: { rate: 148.5, change: "+0.32%", trend: "๐" },
            usd_sar: { rate: 3.75, change: "0.00%", trend: "โก๏ธ" },
            usd_aed: { rate: 3.67, change: "0.00%", trend: "โก๏ธ" }
        },
        commodities: {
            gold: { price: 2345.67, change: "+0.45%", trend: "๐" },
            oil: { price: 78.34, change: "-0.23%", trend: "๐" },
            silver: { price: 28.91, change: "+0.67%", trend: "๐" }
        }
    };
    
    res.json({
        live: true,
        timestamp: new Date().toISOString(),
        updateFrequency: "10 ุซูุงูู",
        markets: markets,
        topPerformer: "SOL (+1.58%)",
        topDecliner: "EUR/USD (-0.15%)",
        recommendation: "ูุฑุต ุฌูุฏุฉ ูู ุงูุนููุงุช ุงูุฑูููุฉ ูุงูุนููุงุช ุงูุขุณูููุฉ"
    });
});

// ==================== ๐ ุงูุตูุญุฉ ุงูุฑุฆูุณูุฉ ====================
app.get('/', (req, res) => {
    res.sendFile(__dirname + '/index.html');
});

// ==================== ๐ค ุตูุญุฉ ุงุฎุชุจุงุฑ ุงูุฑูุจูุช ====================
app.get('/test-robot-simple.html', (req, res) => {
    res.sendFile(__dirname + '/test-robot-simple.html');
});

// ==================== ๐ ูููุงุช ุฅุถุงููุฉ ====================
app.get('/dashboard', (req, res) => {
    res.redirect('/');
});

app.get('/control-panel', (req, res) => {
    res.redirect('/');
});

app.get('/imperial-admin', (req, res) => {
    res.redirect('/');
});

// ==================== โ ุตูุญุฉ 404 ุฐููุฉ ====================
app.use((req, res) => {
    const suggestions = [
        { path: '/', title: 'ููุญุฉ ุงูุชุญูู ุงูุฑุฆูุณูุฉ' },
        { path: '/api/status', title: 'ุญุงูุฉ ุงููุธุงู' },
        { path: '/health', title: 'ุตุญุฉ ุงููุธุงู' },
        { path: '/test-robot-simple.html', title: 'ุชุญูู ุจุงูุฑูุจูุชุงุช' }
    ];
    
    res.status(404).json({
        error: "ุงูุตูุญุฉ ุบูุฑ ููุฌูุฏุฉ",
        message: "ูุฐู ุงูุตูุญุฉ ุบูุฑ ููุฌูุฏุฉ ูู ุงููุธุงู ุงูุฅูุจุฑุงุทูุฑู",
        code: "IMPERIAL_404",
        requestedUrl: req.url,
        method: req.method,
        suggestions: suggestions,
        quickActions: {
            goHome: "/",
            checkAPI: "/api/status",
            viewRobots: "/test-robot-simple.html"
        },
        timestamp: new Date().toISOString(),
        support: "contact@novaapp.tech"
    });
});

// ==================== ๐ ูุนุงูุฌุฉ ุงูุฃุฎุทุงุก ุงูุฐููุฉ ====================
app.use((err, req, res, next) => {
    console.error('๐๏ธ ุฎุทุฃ ุฅูุจุฑุงุทูุฑู:', {
        error: err.message,
        stack: err.stack,
        url: req.url,
        method: req.method,
        timestamp: new Date().toISOString()
    });
    
    const errorResponse = {
        error: "ุฎุทุฃ ุฏุงุฎูู ูู ุงููุธุงู",
        message: "ุญุฏุซ ุฎุทุฃ ุบูุฑ ูุชููุน",
        code: "IMPERIAL_500",
        errorId: `ERR_${Date.now()}_${Math.random().toString(36).substr(2, 6)}`,
        timestamp: new Date().toISOString(),
        status: 500,
        recovery: {
            automatic: true,
            estimatedTime: "30 ุซุงููุฉ",
            action: "ุฌุงุฑู ุฅุนุงุฏุฉ ุชุดุบูู ุงููุธุงู ุงููุฑุนู"
        }
    };
    
    // ุฅุถุงูุฉ ูุนูููุงุช ุฅุถุงููุฉ ูู ูุถุน ุงูุชุทููุฑ
    if (process.env.NODE_ENV !== 'production') {
        errorResponse.debug = {
            originalError: err.message,
            stack: err.stack
        };
    }
    
    res.status(500).json(errorResponse);
});

// ==================== ๐ ุชุดุบูู ุงููุธุงู ุงูุฅูุจุฑุงุทูุฑู ====================
const server = app.listen(PORT, () => {
    const startupTime = new Date();
    
    console.log('\n' + '='.repeat(60));
    console.log('๐๏ธ  ุฅูุจุฑุงุทูุฑูุฉ ุฌุณุฑ ุงูุชุฌุงุฑุฉ ุงูุนุงูููุฉ - ุงููุธุงู ุงููุฑูุฒู');
    console.log('='.repeat(60));
    console.log(`๐ ุงูููุฏ: TB-2024-LEGEND`);
    console.log(`๐ ุงููุทุงู: https://novaapp.tech`);
    console.log(`๐ ุงูุฅุตุฏุงุฑ: Imperial Core 2.0 - ุงูุฌูุด ุงูุขูู`);
    console.log(`โฐ ููุช ุงูุชุดุบูู: ${startupTime.toLocaleString('ar-SA')}`);
    console.log('โ'.repeat(60));
    console.log(`๐ก ุงููุธุงู ูุนูู ุนูู: http://localhost:${PORT}`);
    console.log(`๐ ุงููุงุฌูุฉ ุงูุฑุฆูุณูุฉ: https://novaapp.tech`);
    console.log(`โ๏ธ  API ุงูุฅูุจุฑุงุทูุฑู: https://novaapp.tech/api/status`);
    console.log(`๐ค ุฌูุด ุงูุฑูุจูุชุงุช: https://novaapp.tech/api/robots/status`);
    console.log(`โค๏ธ  ูุธุงู ุงูุตุญุฉ: https://novaapp.tech/health`);
    console.log(`๐ ุงูุฃุณูุงู ุงูุญูุฉ: https://novaapp.tech/api/markets/live`);
    console.log(`๐ ุชูุงุซุฑ ุงูุฑูุจูุชุงุช: https://novaapp.tech/api/robots/replicate/5`);
    console.log(`๐ฎ ููุญุฉ ุงูุชุญูู: https://novaapp.tech/test-robot-simple.html`);
    console.log('โ'.repeat(60));
    console.log(`๐พ ุงูุฐุงูุฑุฉ: ${Math.round(process.memoryUsage().heapUsed / 1024 / 1024)}MB`);
    console.log(`๐ Node.js: ${process.version}`);
    console.log(`๐ฅ๏ธ  ุงููุธุงู: ${process.platform}`);
    console.log('='.repeat(60));
    console.log('๐๏ธ  ุงููุธุงู ุงูุฅูุจุฑุงุทูุฑู ุฌุงูุฒ ููุฃูุงูุฑ...\n');
    
    // ุฑุณุงูุฉ ุชุฑุญูุจ ุชููุงุฆูุฉ
    setTimeout(() => {
        console.log('๐ค ุฌูุด ุงูุฑูุจูุชุงุช ุงูุฅูุจุฑุงุทูุฑูุฉ ููุทูู...');
        console.log('๐ ุฌุณุฑ ุงูุชุฌุงุฑุฉ ุงูุนุงูููุฉ ููุนู...');
        console.log('๐ก๏ธ ุงููุธุงู ุงูุฃููู ูู ุฃุนูู ูุณุชููุงุช ุงูุชุฃูุจ...');
    }, 1000);
});

// ==================== ๐ ุฅุบูุงู ุขูู ูุชูุฏู ====================
const gracefulShutdown = (signal) => {
    console.log(`\n๐๏ธ  ุงุณุชูุงู ุฅุดุงุฑุฉ ${signal}...`);
    console.log('๐๏ธ  ุงููุธุงู ูุบูู ุจุฃูุงูุฉ...');
    
    // ุญูุธ ุงูุจูุงูุงุช ูุจู ุงูุฅุบูุงู
    console.log('๐พ ุฌุงุฑู ุญูุธ ุจูุงูุงุช ุงูุฅูุจุฑุงุทูุฑูุฉ...');
    
    // ุฅุบูุงู ุงูุฎุงุฏู
    server.close(() => {
        console.log('โ ุชู ุฅุบูุงู ุฎุงุฏู HTTP');
        console.log('๐๏ธ  ุงููุธุงู ุงูุฅูุจุฑุงุทูุฑู ูุบูู ุจุฃูุงู');
        console.log('๐ ุฌุงูุฒ ูุฅุนุงุฏุฉ ุงูุชุดุบูู ุนูุฏ ุงูุทูุจ');
        console.log('='.repeat(60));
        process.exit(0);
    });
    
    // ุฅุบูุงู ูุณุฑู ุจุนุฏ 10 ุซูุงูู
    setTimeout(() => {
        console.error('โฐ ุงูุชูู ููุช ุงูุฅุบูุงู ุงูุขููุ ุฅุบูุงู ูุณุฑู');
        process.exit(1);
    }, 10000);
};

// ูุนุงูุฌุฉ ุฅุดุงุฑุงุช ุงูุฅุบูุงู
process.on('SIGTERM', () => gracefulShutdown('SIGTERM'));
process.on('SIGINT', () => gracefulShutdown('SIGINT'));

// ูุนุงูุฌุฉ ุฃุฎุทุงุก ุบูุฑ ูุชููุนุฉ
process.on('uncaughtException', (err) => {
    console.error('๐ฅ ุฎุทุฃ ุบูุฑ ูุชููุน:', err);
    gracefulShutdown('UNCAUGHT_EXCEPTION');
});

process.on('unhandledRejection', (reason, promise) => {
    console.error('โ๏ธ ูุนุฏ ูุฑููุถ ุจุฏูู ูุนุงูุฌุฉ:', reason);
});

// ==================== ๐ซ ุจุฏุงูุฉ ุงูุฅูุจุฑุงุทูุฑูุฉ ====================
console.log('๐๏ธ  ุชุญููู ุงููุธุงู ุงูุฅูุจุฑุงุทูุฑู...');
console.log('๐ค ุชููุฆุฉ ุฌูุด ุงูุฑูุจูุชุงุช...');
console.log('๐ ุชูุนูู ุฌุณุฑ ุงูุชุฌุงุฑุฉ ุงูุนุงูููุฉ...');
console.log('๐ก๏ธ ุชุดุบูู ุงูุฃูุธูุฉ ุงูุฃูููุฉ...');

// ุชุญูู ูู ุงูุงุนุชูุงุฏูุงุช
try {
    require.resolve('express');
    console.log('โ Express.js: ุฌุงูุฒ');
} catch {
    console.log('โ๏ธ Express.js: ูุญุชุงุฌ ุชุซุจูุช (npm install express)');
}

// ุฑุณุงูุฉ ุงูุจุฏุก ุงูููุงุฆูุฉ
setTimeout(() => {
    console.log('\nโจ ' + '='.repeat(50));
    console.log('โจ      ุงูุฅูุจุฑุงุทูุฑูุฉ ุชุนูุด ูุชุชููุณ!');
    console.log('โจ ' + '='.repeat(50));
    console.log('โจ ุงุณุชุฎุฏู ุฃูุงูุฑ ุงููุงุฆุฏ ููุชุญูู ุจุงูุฅูุจุฑุงุทูุฑูุฉ');
    console.log('โจ ูู ุดูุก ุชุญุช ุณูุทุฑุชู...\n');
}, 2000);
